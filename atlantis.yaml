version: 3
abort_on_execution_order_fail: true
automerge: true
projects:
- name: dev
  dir: terragrunt-integration/terraform
  execution_order_group: 1
  branch: /.*/
  autoplan:
    when_modified: ["app1/**/*.hcl","app2/**/*.hcl"]
    enabled: true
  apply_requirements: [mergeable, undiverged]
  silence_pr_comments: ["plan"]
  workflow: dev_workflow
- name: prod
  dir: terragrunt-integration/terraform
  execution_order_group: 2
  depends_on: [dev]
  branch: /.*/
  autoplan:
    when_modified: ["app1/**/*.hcl","app2/**/*.hcl"]
    enabled: true
  apply_requirements: [approved, mergeable, undiverged]
  workflow: prod_workflow

workflows:
  dev_workflow:
    plan:
      steps:
      - run: echo ">>>> DEV PLANNING CHANGES <<<<"
      - env:
          name: TF_IN_AUTOMATION
          value: 'true'
      - run:
          command: terragrunt run plan --var 'environment=dev' --all && echo y | terragrunt apply --var 'environment=dev' --all
          output: strip_refreshing
  prod_workflow:
    plan:
      steps:
      - env:
          name: TF_IN_AUTOMATION
          value: 'true'
      - run:
          command: terragrunt run plan --var 'environment=prod' --all
          output: strip_refreshing
    apply:
      steps:
      - run:
          command: echo y | terragrunt apply --var 'environment=prod' --all
          output: strip_refreshing