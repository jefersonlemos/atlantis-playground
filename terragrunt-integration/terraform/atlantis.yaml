version: 3
abort_on_execution_order_fail: true

projects:
- name: dev_changes
  dir: ["./terraform/app1", "./terraform/app2"]
  branch: "^(?!main$).*"   # any branch except main
  autoplan:
    when_modified: ["*.tf", "*.hcl", "../modules/**/*.tf", ".terraform.lock.hcl"]
    enabled: true
  automerge: true
  workflow: auto-plan       # âœ… only one workflow reference

- name: prod_changes_pr_opened
  dir: ["./terraform/app1", "./terraform/app2"]
  branch: "main"
  pr: "opened"
  workflow: auto-plan
  autoplan:
    enabled: true

- name: prod_changes_pr_approved
  dir: ["./terraform/app1", "./terraform/app2"]
  branch: "main"
  pr: "approved"
  workflow: auto-plan
  autoplan:
    enabled: false

workflows:
  auto-plan:
    plan:
      steps:
      - run: 'echo "terraform${ATLANTIS_TERRAFORM_VERSION}"'
      - run:
          command: echo "Running app1 command hidding output"
          output: hide
      - run:
          command: terragrunt plan -input=false -out=$PLANFILE
          output: strip_refreshing
    apply:
      steps:
      - run: echo "Applying app1 changes"
      - run:
          command: terragrunt apply -input=false -out=$PLANFILE
          output: strip_refreshing