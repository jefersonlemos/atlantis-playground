version: 3
abort_on_execution_order_fail: true

projects:
- name: apps
  dir: ["./terraform"]
  branch: "^(?!main$).*"   # any branch except main
  autoplan:
    when_modified: ["*.tf", "*.hcl", "../modules/**/*.tf", ".terraform.lock.hcl"]
    enabled: true
  automerge: true
  workflow: plan-all

- name: prod_changes_pr_opened
  dir: ["./terraform"]
  branch: "main"
  pr: "opened"
  workflow: plan-all
  autoplan:
    enabled: true

- name: prod_changes_pr_approved
  dir: ["./terraform"]
  branch: "main"
  pr: "approved"
  workflow: plan-all
  autoplan:
    enabled: false

workflows:
  plan-all:
      steps:
      - run: 'echo "terraform${ATLANTIS_TERRAFORM_VERSION}"'
      - run:
          command: echo "Running app1 command hidding output"
          output: hide
      - run:
          command: terragrunt run plan --all
          output: strip_refreshing  
  auto-plan:
    plan:
      steps:
      - run: 'echo "terraform${ATLANTIS_TERRAFORM_VERSION}"'
      - run:
          command: echo "Running app1 command hidding output"
          output: hide
      - run:
          command: terragrunt run plan --all
          output: strip_refreshing
    apply:
      steps:
      - run: echo "Applying app1 changes"
      - run:
          command: terragrunt apply
          output: strip_refreshing