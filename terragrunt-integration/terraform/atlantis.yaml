version: 3
abort_on_execution_order_fail: true

projects:
- name: apps
  dir: ./terraform
  branch: "^(?!main$).*"   # any branch except main
  autoplan:
    when_modified: ["*.tf", "*.hcl", "../modules/**/*.tf", ".terraform.lock.hcl"]
    enabled: true
  automerge: true
  workflow: terragrunt

  #So commitar pra rolar o plan talvez nao role pq o atlantis precisa postar uma msg em algum lugar informando se deu certo o autoplan ou nao
  # entao talvez eu precise  desabilitar essa msg e ai eu olho no atlants, de algum jeito pra ver se rolou o commit ou faco o atlantis abrir o PR automaticamente
  # sempre que rolar o commit na feature branch, acho que essa pode ser uma boa alternativa, melhor que a primeira

- name: prod_changes_pr_opened
  dir: ./terraform
  branch: "main"
  pr: "opened"
  workflow: terragrunt
  autoplan:
    enabled: true

- name: prod_changes_pr_approved
  dir: ./terraform
  branch: "main"
  pr: "approved"
  workflow: terragrunt
  autoplan:
    enabled: false

workflows:
  terragrunt:
    plan:
      steps:
      - run: echo "####### PLANNING APP1 CHANGES #######"
      - run: pwd
      - env:
          name: TERRAGRUNT_TFPATH
          command: 'echo "terraform${ATLANTIS_TERRAFORM_VERSION}"'
      - env:
          # Reduce Terraform suggestion output
          name: TF_IN_AUTOMATION
          value: 'true'
      - run:
          command: terragrunt run plan --all
          output: strip_refreshing